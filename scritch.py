import numpy as np
import requests

def is_raster_layer(layer):
    if layer.type() != QgsMapLayer.RasterLayer:
        return False
    else:
        return True


def get_layer_choices():
    root = QgsProject.instance().layerTreeRoot()
    layers = root.findLayers()
    return [layer.layer() for layer in layers if is_raster_layer(layer.layer())]

cc = qgis.utils.plugins['CircleCraters']
cc.raster_layer = get_layer_choices()[0]

def get_layerz():
    root = QgsProject.instance().layerTreeRoot()
    layers = root.findLayers()
    return [layer for layer in layers]

def sample_area_around(rlayer, x, y, r=16):
    xvalues = np.arange(x-r, x+r)
    yvalues = np.arange(y-r, y+r)
    output = []
    for y in yvalues[::-1]:
        for x in xvalues:
            val, res = rlayer.dataProvider().sample(QgsPointXY(x, y), 1)
            output.append(val)
    return output

#sample_area_around(None, 100, -100)

def make_request(lst):
    url = "http://localhost:8501/detect/"
    body = {"instances": [lst]}
    r = requests.post(url=url, json=body)
    return r.json()


test_arry = np.array([130, 140, 136, 166, 162, 157, 159, 133, 152, 162, 125, 129, 157, 160, 138, 183, 129, 163, 188, 159, 158, 165, 159, 134, 128, 111, 144, 144, 128, 114, 103, 116, 166, 144, 160, 154, 140, 174, 139, 147, 147, 110, 153, 163, 151, 123, 169, 140, 142, 166, 160, 152, 159, 163, 142, 122, 119, 126, 122, 133, 84, 150, 117, 113, 139, 126, 126, 144, 136, 141, 174, 158, 99, 142, 139, 148, 141, 160, 156, 160, 138, 190, 188, 146, 187, 189, 122, 115, 133, 114, 142, 172, 119, 92, 101, 115, 139, 134, 142, 142, 162, 125, 182, 145, 141, 145, 162, 159, 142, 132, 157, 157, 96, 120, 158, 160, 163, 159, 114, 152, 102, 113, 114, 141, 116, 103, 140, 132, 158, 160, 152, 141, 165, 111, 140, 104, 145, 157, 153, 128, 165, 151, 128, 156, 121, 177, 168, 153, 126, 129, 138, 123, 83, 104, 121, 152, 97, 141, 151, 162, 159, 148, 154, 147, 119, 145, 105, 134, 152, 139, 136, 132, 159, 144, 166, 153, 144, 129, 163, 152, 132, 135, 134, 126, 75, 126, 162, 172, 134, 146, 129, 162, 117, 121, 142, 132, 141, 148, 128, 123, 133, 175, 139, 152, 164, 158, 141, 120, 132, 154, 158, 145, 142, 126, 150, 169, 66, 128, 142, 164, 168, 148, 130, 150, 144, 151, 172, 160, 136, 147, 113, 158, 147, 146, 158, 147, 182, 145, 147, 126, 154, 162, 146, 169, 154, 123, 120, 120, 144, 162, 146, 169, 134, 147, 144, 151, 145, 164, 152, 123, 160, 115, 139, 170, 140, 151, 134, 142, 129, 152, 145, 138, 125, 151, 157, 135, 166, 151, 116, 127, 127, 136, 140, 127, 120, 141, 148, 134, 159, 136, 129, 147, 130, 151, 147, 162, 150, 166, 129, 122, 134, 152, 150, 150, 160, 122, 158, 160, 177, 119, 101, 136, 153, 129, 141, 116, 140, 121, 146, 156, 170, 125, 142, 126, 122, 139, 146, 144, 127, 138, 134, 148, 151, 136, 142, 176, 138, 148, 141, 134, 140, 130, 97, 144, 170, 125, 139, 130, 114, 166, 159, 136, 183, 110, 138, 109, 144, 153, 135, 152, 135, 158, 144, 171, 157, 140, 164, 129, 156, 122, 116, 144, 169, 153, 107, 122, 147, 139, 162, 148, 148, 133, 145, 78, 132, 123, 153, 158, 162, 132, 147, 171, 196, 142, 154, 178, 188, 177, 150, 144, 67, 47, 73, 103, 157, 160, 133, 138, 122, 139, 157, 132, 121, 160, 141, 122, 98, 154, 107, 123, 159, 171, 152, 158, 159, 132, 164, 201, 182, 160, 62, 10, 71, 79, 92, 141, 165, 171, 206, 132, 133, 104, 102, 123, 117, 136, 130, 146, 122, 147, 148, 147, 163, 145, 146, 164, 156, 140, 220, 184, 186, 48, 51, 38, 84, 119, 93, 107, 156, 188, 195, 146, 130, 104, 83, 152, 146, 119, 114, 134, 135, 113, 145, 183, 128, 134, 176, 141, 159, 171, 174, 187, 111, 17, 34, 110, 83, 85, 105, 110, 166, 174, 195, 233, 144, 63, 60, 133, 133, 120, 146, 166, 159, 177, 134, 152, 138, 132, 147, 140, 164, 175, 183, 153, 0, 45, 69, 78, 107, 87, 113, 133, 138, 165, 186, 232, 182, 90, 50, 128, 107, 126, 153, 141, 168, 130, 178, 146, 160, 171, 162, 138, 145, 159, 181, 67, 37, 48, 62, 115, 108, 98, 132, 111, 160, 171, 200, 221, 166, 154, 60, 109, 147, 135, 163, 144, 150, 154, 138, 140, 157, 138, 153, 146, 154, 174, 130, 90, 55, 37, 84, 83, 122, 127, 110, 122, 156, 166, 177, 214, 211, 165, 132, 115, 133, 138, 150, 105, 135, 130, 175, 162, 121, 141, 165, 140, 151, 168, 134, 105, 45, 61, 73, 116, 117, 121, 129, 154, 142, 158, 189, 195, 211, 176, 113, 109, 164, 140, 144, 107, 129, 134, 158, 178, 152, 142, 166, 148, 163, 165, 108, 77, 92, 71, 78, 91, 96, 121, 148, 135, 163, 181, 200, 219, 213, 195, 119, 97, 132, 154, 132, 139, 114, 151, 194, 142, 120, 133, 138, 156, 158, 150, 150, 105, 97, 55, 74, 116, 99, 111, 136, 156, 192, 186, 200, 255, 171, 134, 97, 101, 133, 119, 135, 125, 134, 132, 132, 121, 148, 134, 146, 146, 166, 140, 144, 148, 119, 122, 95, 125, 142, 153, 153, 186, 208, 200, 232, 218, 140, 96, 107, 139, 147, 144, 119, 117, 126, 103, 153, 140, 151, 138, 158, 171, 178, 151, 165, 152, 153, 144, 97, 134, 123, 151, 172, 181, 186, 202, 184, 141, 117, 84, 119, 148, 150, 107, 144, 139, 154, 138, 119, 134, 144, 171, 127, 144, 174, 142, 160, 151, 159, 160, 130, 116, 120, 104, 156, 176, 181, 165, 136, 109, 165, 108, 129, 153, 123, 107, 119, 135, 148, 130, 135, 138, 148, 151, 151, 140, 141, 133, 158, 139, 162, 151, 153, 150, 116, 160, 162, 90, 126, 126, 109, 104, 162, 146, 116, 139, 145, 152, 132, 102, 160, 132, 154, 135, 135, 148, 172, 147, 160, 146, 147, 135, 172, 188, 148, 114, 102, 123, 130, 163, 116, 125, 141, 133, 130, 141, 134, 121, 141, 126, 128, 126, 141, 136, 129, 139, 141, 147, 146, 166, 147, 146, 140, 164, 145, 148, 146, 135, 113, 152, 177, 122, 120, 152, 105, 166, 126, 139, 139, 136, 142, 135, 154, 132, 120, 117, 136, 135, 128, 127, 140, 159, 172, 171, 168, 174, 148, 147, 171, 144, 127, 110, 177, 101, 135, 158, 122, 132, 139, 156, 159, 146, 169, 136, 150, 132, 122, 139, 163, 127, 151, 162, 130, 141, 176, 160, 132, 145, 168, 152, 151, 160, 122, 135, 123, 119, 151, 128, 157, 128, 130, 160, 140, 170, 135, 145, 170, 141, 144, 109, 146, 133, 151, 150, 153, 145, 146, 150, 135, 145, 147, 156, 120, 132, 153, 141, 119, 132, 126, 159, 160, 122, 160, 165, 145, 144, 122, 153, 123, 114, 117, 130, 62, 130, 142, 153, 135, 138, 145, 146, 128, 157, 145, 178, 136, 151, 144, 141, 163, 144, 152, 163, 163, 135, 159, 132, 151, 152, 150, 117, 121, 150])
resp = make_request(test_arry)
x = sample_area_around(None, 140, -100)
#print(x)
#print(resp)

my_plugin = qgis.utils.plugins['CircleCraters']